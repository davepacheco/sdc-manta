#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#

#
# Copyright (c) 2017, Joyent, Inc.
#

#
# amon probes for the "nameservice" service
#

-
    event: upset.manta.nameservice.ZK--logscan--ERROR-
    legacyName: "ZK: logscan 'ERROR'"
    scope: 
        service: nameservice
    checks: 
        - 
            type: log-scan
            config: 
                path: "/var/log/zookeeper/zookeeper.out"
                match: 
                    pattern: ERROR
                threshold: 1
                period: 60
    ka: 
        title: "ZK: logscan 'ERROR'"
        description: XXX-UNKNOWN
        severity: XXX-UNKNOWN
        response: XXX-UNKNOWN
        impact: XXX-UNKNOWN
        action: XXX-UNKNOWN

-
    event: upset.manta.nameservice.ZK--logscan--Connection-refused-
    legacyName: "ZK: logscan 'Connection refused'"
    scope: 
        service: nameservice
    checks: 
        - 
            type: log-scan
            config: 
                path: "/var/log/zookeeper/zookeeper.out"
                match: 
                    pattern: "java.net.ConnectException: Connection refused"
                threshold: 1
                period: 60
    ka: 
        title: "ZK: logscan 'Connection refused'"
        description: XXX-UNKNOWN
        severity: XXX-UNKNOWN
        response: XXX-UNKNOWN
        impact: XXX-UNKNOWN
        action: XXX-UNKNOWN

-
    event: upset.manta.nameservice.binder--logscan
    legacyName: "binder: logscan"
    scope: 
        service: nameservice
    checks: 
        - 
            type: bunyan-log-scan
            config: 
                smfServiceName: binder
                fields: 
                    level: ERROR
                threshold: 1
                period: 60
    ka: 
        title: "binder: logscan"
        description: XXX-UNKNOWN
        severity: XXX-UNKNOWN
        response: XXX-UNKNOWN
        impact: XXX-UNKNOWN
        action: XXX-UNKNOWN

-
    event: upset.manta.nameservice.mbackup--logs-not-uploaded
    legacyName: "mbackup: logs not uploaded"
    scope: 
        service: nameservice
    checks: 
        - 
            type: cmd
            config: 
                cmd: "test ! $(find /var/log/manta/upload -type f | wc -l) -gt 0"
                interval: 300
                threshold: 5
                period: 1800
    ka: 
        title: "mbackup: logs not uploaded"
        description: XXX-UNKNOWN
        severity: XXX-UNKNOWN
        response: XXX-UNKNOWN
        impact: XXX-UNKNOWN
        action: XXX-UNKNOWN

-
    event: upset.manta.nameservice.ZK--ruok
    legacyName: "ZK: ruok"
    scope: 
        service: nameservice
    checks: 
        - 
            type: cmd
            config: 
                cmd: "echo 'ruok' | nc localhost 2181"
                stdoutMatch: 
                    pattern: imok
                    invert: true
                threshold: 1
                period: 60
    ka: 
        title: "ZK: ruok"
        description: XXX-UNKNOWN
        severity: XXX-UNKNOWN
        response: XXX-UNKNOWN
        impact: XXX-UNKNOWN
        action: XXX-UNKNOWN

